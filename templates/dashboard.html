{% extends 'layout.html' %}

{% block content %}
<!-- Confetti Canvas for celebrations -->
<canvas id="confetti-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;"></canvas>

<div id="dashboard-content">


    <!-- Tesla-style Dashboard Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">LOGISTICS DASHBOARD</h4>
        <div class="d-flex align-items-center gap-3">
            <!-- View Toggle -->
            <div class="btn-group" role="group" aria-label="View Toggle">
                <input type="radio" class="btn-check" name="view-toggle" id="company-view" autocomplete="off" checked>
                <label class="btn btn-sm btn-outline-primary" for="company-view">
                    <i data-feather="home"></i> Company
                </label>
                <input type="radio" class="btn-check" name="view-toggle" id="driver-view" autocomplete="off">
                <label class="btn btn-sm btn-outline-primary" for="driver-view">
                    <i data-feather="user"></i> Individual
                </label>
            </div>
            
            <!-- Date Range Controls -->
            <select class="form-select form-select-sm" id="date-range-select" style="width: 140px;">
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 90 Days</option>
                <option value="custom">Custom Range</option>
            </select>
            
            <!-- Custom Date Range (Hidden by default) -->
            <div id="custom-date-controls" class="d-none">
                <div class="d-flex gap-2">
                    <input type="date" class="form-control form-control-sm" id="start-date" value="2025-05-01" style="width: 130px;">
                    <input type="date" class="form-control form-control-sm" id="end-date" value="2025-05-31" style="width: 130px;">
                    <button class="btn btn-sm btn-success" id="apply-custom-range">Apply</button>
                </div>
            </div>
            
            <!-- Driver Selection (Hidden by default) -->
            <select class="form-select form-select-sm d-none" id="driver-select" style="width: 150px;">
                <option value="">Select Driver...</option>
            </select>
            
            <!-- Safe Mode Toggle -->
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="safe-mode-toggle">
                <label class="form-check-label text-warning" for="safe-mode-toggle">
                    <i data-feather="shield"></i> Safe Mode
                </label>
            </div>
            <button class="btn btn-sm btn-primary px-3" id="refresh-dashboard">
                <i data-feather="refresh-cw"></i> REFRESH
            </button>
        </div>
    </div>

    <!-- Tesla-style Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- On-Time Percentage Metric -->
        <div class="dashboard-card">
            <div class="dashboard-card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <span id="on-time-rate-title">ON-TIME RATE</span>
                    <!-- Toggle Buttons in Header -->
                    <div class="btn-group btn-group-sm on-time-toggle-group" role="group" aria-label="On-time rate type">
                        <button type="button" class="btn on-time-toggle" data-type="delivery" id="delivery-toggle">
                            Delivery
                        </button>
                        <button type="button" class="btn on-time-toggle" data-type="pickup" id="pickup-toggle">
                            Pickup
                        </button>
                        <button type="button" class="btn on-time-toggle active" data-type="overall" id="overall-toggle">
                            Overall
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="info-btn" data-bs-toggle="modal" data-bs-target="#info-modal" 
                            data-title="On-Time Rate Calculation" 
                            data-content="Toggle between three performance metrics: Delivery Rate (on-time deliveries only), Pickup Rate (on-time pickups only), and Overall Rate (loads where both pickup AND delivery occurred on or before scheduled times). Each metric uses actual arrival times compared to scheduled times.">
                        <i data-feather="info" style="width: 14px; height: 14px;"></i>
                    </button>
                    <i data-feather="clock" style="color: var(--primary-action); opacity: 0.8;"></i>
                </div>
            </div>
            <div class="dashboard-card-body">
                <div class="circular-metric" style="--percent: 87;" id="on-time-circular-metric">
                    <div class="circular-metric-value"><span id="on-time-percentage">87</span>%</div>
                    <svg viewBox="0 0 160 160" width="160" height="160">
                        <circle r="70" cx="80" cy="80" class="bg-circle" />
                        <circle r="70" cx="80" cy="80" class="progress-circle" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Late Shipments Metric -->
        <div class="dashboard-card">
            <div class="dashboard-card-header d-flex justify-content-between align-items-center">
                <span>LATE SHIPMENTS</span>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="info-btn" data-bs-toggle="modal" data-bs-target="#info-modal" 
                            data-title="Late Shipments Counter" 
                            data-content="Counts the total number of loads with late deliveries that arrived after the scheduled delivery time. This metric focuses specifically on delivery performance and includes all loads where actual delivery arrival exceeded the promised delivery window.">
                        <i data-feather="info" style="width: 14px; height: 14px;"></i>
                    </button>
                    <i data-feather="alert-circle" style="color: var(--highlight-alert); opacity: 0.8;"></i>
                </div>
            </div>
            <div class="dashboard-card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background-color: var(--highlight-alert);"></div>
                    </div>
                    <div>
                        <h2 id="late-loads-count" class="mb-0 slot-machine-effect" style="font-size: 3rem; color: var(--highlight-alert); text-shadow: 0 0 10px rgba(255, 87, 87, 0.4);">5</h2>
                    </div>
                </div>
                <div class="mt-3">
                    <div id="late-trend-chart" style="height: 50px;">
                        <!-- Mini chart goes here -->
                        <svg width="100%" height="100%" viewBox="0 0 200 50">
                            <path d="M0,40 L20,35 L40,38 L60,30 L80,32 L100,25 L120,28 L140,20 L160,22 L180,15 L200,18" 
                                  fill="none" 
                                  stroke-width="2" 
                                  stroke="#FFD700" 
                                  style="filter: drop-shadow(0 0 3px rgba(255, 215, 0, 0.5));"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Deliveries Metric -->
        <div class="dashboard-card">
            <div class="dashboard-card-header d-flex justify-content-between align-items-center">
                <span>DELIVERIES</span>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="info-btn" data-bs-toggle="modal" data-bs-target="#info-modal" 
                            data-title="Active Loads Counter" 
                            data-content="Shows the total number of loads currently active in the system (scheduled or in-transit). This includes all loads that have been dispatched but not yet delivered. Driver and top performer stats are shown below.">
                        <i data-feather="info" style="width: 14px; height: 14px;"></i>
                    </button>
                    <i data-feather="package" style="color: var(--primary-action); opacity: 0.8;"></i>
                </div>
            </div>
            <div class="dashboard-card-body text-center">
                <div class="d-flex justify-content-center align-items-center" style="height: 120px;">
                    <h2 id="active-loads-count" class="mb-0 display-4 fw-bold slot-machine-effect" style="font-size: 4rem; color: var(--primary-action); text-shadow: 0 0 15px var(--primary-glow);">120</h2>
                </div>
                <div id="company-stats" class="mt-3 d-flex justify-content-between">
                    <div class="text-start">
                        <h6 class="mb-1 text-neutral-text">DRIVERS</h6>
                        <span id="total-drivers-count" style="color: var(--bright-text);">34</span>
                    </div>
                    <div class="text-end">
                        <h6 class="mb-1 text-neutral-text">TOP DRIVER</h6>
                        <span id="top-driver-info" style="color: var(--celebration-gold);">Ryan (29)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Map and At-Risk Loads Section -->
    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
        <!-- Active Loads Map with Tesla-style dark theme -->
        <div class="dashboard-card" style="min-height: 400px;">
            <div class="dashboard-card-header d-flex justify-content-between align-items-center">
                <span>ACTIVE LOADS MAP</span>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="info-btn" data-bs-toggle="modal" data-bs-target="#info-modal" 
                            data-title="Active Loads Map View" 
                            data-content="Real-time map showing locations of all active loads and vehicles. Green markers indicate pickup locations, red markers show delivery destinations, and blue dots represent current vehicle positions with live tracking.">
                        <i data-feather="info" style="width: 14px; height: 14px;"></i>
                    </button>
                    <i data-feather="map-pin" style="color: var(--primary-action); opacity: 0.8;"></i>
                </div>
            </div>
            <div class="dashboard-card-body p-0">
                <div id="tracking-map" style="height: 360px; border-radius: 0 0 16px 16px; overflow: hidden;"></div>
                <div class="position-absolute" style="bottom: 20px; left: 20px; z-index: 100;">
                    <button class="btn btn-sm btn-primary" style="backdrop-filter: blur(10px); background-color: rgba(0, 196, 140, 0.2); border: 1px solid var(--primary-action);">
                        <i data-feather="truck" style="width: 16px; height: 16px;"></i> TRACK
                    </button>
                </div>
            </div>
        </div>
        
        <!-- At-Risk Loads in Tesla-style dark theme -->
        <div class="dashboard-card">
            <div class="dashboard-card-header d-flex justify-content-between align-items-center">
                <span>LOADS AT RISK</span>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="info-btn" data-bs-toggle="modal" data-bs-target="#info-modal" 
                            data-title="Loads At Risk Analysis" 
                            data-content="Lists loads at risk of missing scheduled times for either pickup or delivery events. Uses current vehicle location, traffic conditions, and estimated travel time to identify potential delays. Shows separate indicators for pickup risk vs delivery risk with time remaining until each deadline.">
                        <i data-feather="info" style="width: 14px; height: 14px;"></i>
                    </button>
                    <i data-feather="alert-triangle" style="color: var(--highlight-alert); opacity: 0.8;"></i>
                </div>
            </div>
            <div class="dashboard-card-body" style="max-height: 360px; overflow-y: auto;">
                <div id="no-at-risk-loads" class="text-center py-4 d-none">
                    <i data-feather="check-circle" style="color: var(--primary-action); width: 48px; height: 48px; margin-bottom: 1rem;"></i>
                    <h5 style="color: var(--bright-text);">No Loads At Risk</h5>
                    <p style="color: var(--neutral-text);">All deliveries are on track</p>
                </div>
                
                <div id="at-risk-loads-content">
                    <!-- Loads will be populated by JavaScript from authentic database data -->
                </div>
                
                <table id="at-risk-loads-table" class="table table-hover d-none" style="color: var(--bright-text); margin-top: 1rem;">
                    <thead>
                        <tr style="color: var(--neutral-text); border-color: var(--border-color);">
                            <th>Reference #</th>
                            <th>Driver</th>
                            <th>Scheduled</th>
                            <th>ETA</th>
                            <th>Delay</th>
                        </tr>
                    </thead>
                    <tbody id="at-risk-loads-body">
                        <!-- Dynamically filled by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Performance Charts and Driver Rankings - Tesla-style -->
    <div class="dashboard-grid" style="grid-template-columns: 2fr 1fr;">
        <!-- Performance Trends Chart -->
        <div class="dashboard-card">
            <div class="dashboard-card-header d-flex justify-content-between align-items-center">
                <span>PERFORMANCE TRENDS</span>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="info-btn" data-bs-toggle="modal" data-bs-target="#info-modal" 
                            data-title="Performance Trends Chart" 
                            data-content="Shows daily on-time delivery performance over the past 30 days. The line chart displays percentage of loads delivered on time each day, helping identify performance patterns and trends over time.">
                        <i data-feather="info" style="width: 14px; height: 14px;"></i>
                    </button>
                    <i data-feather="trending-up" style="color: var(--primary-action); opacity: 0.8;"></i>
                </div>
            </div>
            <div class="dashboard-card-body" style="padding: 20px;">
                <canvas id="performance-chart" height="280"></canvas>
            </div>
        </div>
        
        <!-- Driver Performance Rankings -->
        <div class="dashboard-card">
            <div class="dashboard-card-header d-flex justify-content-between align-items-center">
                <span>TOP DRIVERS</span>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="info-btn" data-bs-toggle="modal" data-bs-target="#info-modal" 
                            data-title="Top Drivers Ranking" 
                            data-content="Displays drivers ranked by their on-time delivery percentage. Rankings are based on actual performance data from completed loads, showing the percentage of deliveries each driver completed on or before scheduled time.">
                        <i data-feather="info" style="width: 14px; height: 14px;"></i>
                    </button>
                    <i data-feather="award" style="color: var(--celebration-gold); opacity: 0.8;"></i>
                </div>
            </div>
            <div class="dashboard-card-body p-0">
                <!-- Driver Ranking List -->
                <div class="list-group list-group-flush bg-transparent" id="top-drivers-list" style="border-radius: 0 0 16px 16px; overflow: hidden;">
                    <!-- Driver #1 -->
                    <div class="list-group-item driver-ranking-item d-flex justify-content-between align-items-center bg-transparent border-0 border-bottom border-dark px-3 py-3" style="border-color: var(--border-color) !important;">
                        <div class="d-flex align-items-center">
                            <div class="d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px; background-color: var(--celebration-gold); border-radius: 50%; color: #000; font-weight: 700;">1</div>
                            <div>
                                <span style="color: var(--bright-text); font-weight: 600;">Jonathan C.</span>
                                <div style="color: var(--neutral-text); font-size: 0.75rem;">20 on-time loads</div>
                            </div>
                        </div>
                        <div>
                            <span style="color: var(--primary-action); font-size: 1.25rem; font-weight: 700;">94%</span>
                        </div>
                    </div>
                    
                    <!-- Driver #2 -->
                    <div class="list-group-item driver-ranking-item d-flex justify-content-between align-items-center bg-transparent border-0 border-bottom border-dark px-3 py-3" style="border-color: var(--border-color) !important;">
                        <div class="d-flex align-items-center">
                            <div class="d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px; background-color: #C0C0C0; border-radius: 50%; color: #000; font-weight: 700;">2</div>
                            <div>
                                <span style="color: var(--bright-text); font-weight: 600;">Ryan T.</span>
                                <div style="color: var(--neutral-text); font-size: 0.75rem;">18 on-time loads</div>
                            </div>
                        </div>
                        <div>
                            <span style="color: var(--primary-action); font-size: 1.25rem; font-weight: 700;">92%</span>
                        </div>
                    </div>
                    
                    <!-- Driver #3 -->
                    <div class="list-group-item driver-ranking-item d-flex justify-content-between align-items-center bg-transparent border-0 border-bottom border-dark px-3 py-3" style="border-color: var(--border-color) !important;">
                        <div class="d-flex align-items-center">
                            <div class="d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px; background-color: #CD7F32; border-radius: 50%; color: #000; font-weight: 700;">3</div>
                            <div>
                                <span style="color: var(--bright-text); font-weight: 600;">Alex M.</span>
                                <div style="color: var(--neutral-text); font-size: 0.75rem;">15 on-time loads</div>
                            </div>
                        </div>
                        <div>
                            <span style="color: var(--primary-action); font-size: 1.25rem; font-weight: 700;">89%</span>
                        </div>
                    </div>
                    
                    <!-- Loading State (initially hidden) -->
                    <div class="list-group-item text-center bg-transparent border-0 d-none">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2" style="color: var(--neutral-text);">Loading top drivers...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions - Tesla-style -->
    <div class="dashboard-card mb-4">
        <div class="dashboard-card-header d-flex justify-content-between align-items-center">
            <span>QUICK ACTIONS</span>
            <i data-feather="zap" style="color: var(--celebration-gold); opacity: 0.8;"></i>
        </div>
        <div class="dashboard-card-body">
            <div class="d-flex flex-wrap gap-3">
                <a href="{{ url_for('loads.create_load') }}" class="action-button">
                    <div class="action-icon">
                        <i data-feather="plus"></i>
                    </div>
                    <div class="action-text">NEW LOAD</div>
                </a>
                
                <a href="{{ url_for('loads.index') }}" class="action-button">
                    <div class="action-icon">
                        <i data-feather="list"></i>
                    </div>
                    <div class="action-text">VIEW LOADS</div>
                </a>
                
                <a href="{{ url_for('drivers.scorecards') }}" class="action-button">
                    <div class="action-icon">
                        <i data-feather="award"></i>
                    </div>
                    <div class="action-text">SCORECARDS</div>
                </a>
                
                <a href="{{ url_for('geofencing.index') }}" class="action-button">
                    <div class="action-icon">
                        <i data-feather="map-pin"></i>
                    </div>
                    <div class="action-text">GEOFENCES</div>
                </a>
            </div>
        </div>
    </div>
    
    <style>
        /* Tesla-style action buttons */
        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
            border-radius: 12px;
            background-color: rgba(30, 31, 37, 0.7);
            border: 1px solid var(--border-color);
            color: var(--bright-text);
            text-decoration: none;
            transition: all 0.3s ease;
            min-width: 130px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .action-button:hover {
            transform: translateY(-5px);
            background-color: rgba(0, 196, 140, 0.1);
            border-color: var(--primary-action);
            box-shadow: 0 8px 20px rgba(0, 196, 140, 0.15);
            color: var(--bright-text);
        }
        
        .action-icon {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--primary-action);
            filter: drop-shadow(0 0 5px var(--primary-glow));
        }
        
        .action-text {
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        /* Info button styles */
        .info-btn {
            background: none;
            border: none;
            color: var(--neutral-text);
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .info-btn:hover {
            background-color: rgba(0, 196, 140, 0.1);
            color: var(--primary-action);
            transform: scale(1.1);
        }
        
        /* On-time toggle button styles */
        .on-time-toggle-group {
            border-radius: 6px;
            overflow: hidden;
        }
        
        .on-time-toggle {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--neutral-text);
            font-size: 11px;
            padding: 4px 10px;
            transition: all 0.2s ease;
            border-radius: 0;
        }
        
        .on-time-toggle:hover {
            background-color: rgba(0, 196, 140, 0.1);
            border-color: var(--primary-action);
            color: var(--bright-text);
        }
        
        .on-time-toggle.active {
            background-color: var(--primary-action);
            border-color: var(--primary-action);
            color: #000;
            font-weight: 600;
        }
        
        .on-time-toggle:first-child {
            border-top-left-radius: 6px;
            border-bottom-left-radius: 6px;
        }
        
        .on-time-toggle:last-child {
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
        }
    </style>
</div>

<!-- Info Modal -->
<div class="modal fade" id="info-modal" tabindex="-1" aria-labelledby="info-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #1e1f25; border: 1px solid rgba(0, 196, 140, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(0, 196, 140, 0.2); background-color: #1a1b20;">
                <h5 class="modal-title" id="info-modal-label" style="color: #ffffff; font-weight: 600;">Section Information</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="info-modal-body" style="color: #e0e0e0; background-color: #1e1f25; line-height: 1.6; font-size: 14px;">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(0, 196, 140, 0.2); background-color: #1a1b20;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background-color: #333; border-color: #555; color: #fff;">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden success alert for milestones -->
<div id="celebration-message" class="celebration-message mb-3 d-none"></div>
{% endblock %}

{% block scripts %}
<!-- Include Dashboard Scripts -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/maps.js') }}"></script>
<script src="{{ url_for('static', filename='js/tracking.js') }}"></script>
<script src="{{ url_for('static', filename='js/animations.js') }}"></script>

<!-- Info Modal JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle info button clicks
    const infoButtons = document.querySelectorAll('.info-btn');
    const infoModal = document.getElementById('info-modal');
    const infoModalLabel = document.getElementById('info-modal-label');
    const infoModalBody = document.getElementById('info-modal-body');
    
    infoButtons.forEach(button => {
        button.addEventListener('click', function() {
            const title = this.getAttribute('data-title');
            const content = this.getAttribute('data-content');
            
            infoModalLabel.textContent = title;
            infoModalBody.textContent = content;
        });
    });
    
    // Handle on-time rate toggle buttons
    const onTimeToggles = document.querySelectorAll('.on-time-toggle');
    const onTimePercentageElement = document.getElementById('on-time-percentage');
    const onTimeCircularMetric = document.getElementById('on-time-circular-metric');
    const onTimeRateTitle = document.getElementById('on-time-rate-title');
    
    // Store the data for different metrics
    let onTimeData = {
        delivery: 0,
        pickup: 0,
        overall: 0
    };
    
    onTimeToggles.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            onTimeToggles.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            this.classList.add('active');
            
            const type = this.getAttribute('data-type');
            updateOnTimeDisplay(type);
        });
    });
    
    function updateOnTimeDisplay(type) {
        let percentage = onTimeData[type];
        let title = '';
        
        switch(type) {
            case 'delivery':
                title = 'DELIVERY RATE';
                break;
            case 'pickup':
                title = 'PICKUP RATE';
                break;
            case 'overall':
                title = 'ON-TIME RATE';
                break;
        }
        
        onTimeRateTitle.textContent = title;
        onTimePercentageElement.textContent = Math.round(percentage);
        onTimeCircularMetric.style.setProperty('--percent', percentage);
    }
    
    // Function to update on-time data from dashboard data
    window.updateOnTimeData = function(dashboardData) {
        if (dashboardData && dashboardData.on_time) {
            onTimeData.delivery = dashboardData.on_time.delivery_percentage || 0;
            onTimeData.pickup = dashboardData.on_time.pickup_percentage || 0;
            onTimeData.overall = dashboardData.on_time.overall_percentage || 0;
            
            // Update display based on current active toggle
            const activeToggle = document.querySelector('.on-time-toggle.active');
            if (activeToggle) {
                updateOnTimeDisplay(activeToggle.getAttribute('data-type'));
            }
        }
    };
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set up refresh button
        document.getElementById('refresh-dashboard').addEventListener('click', function() {
            loadDashboardSummary();
            loadAtRiskLoads();
            
            // Show button loading state
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';
            this.disabled = true;
            
            // Reset button after 1 second
            setTimeout(() => {
                this.innerHTML = '<i data-feather="refresh-cw"></i> Refresh';
                this.disabled = false;
                feather.replace();
            }, 1000);
        });
    });
    
    // Initialize map on the dashboard page
    function initMap() {
        // Regular map initialization
        const mapElement = document.getElementById('tracking-map');
        if (mapElement) {
            map = new google.maps.Map(mapElement, {
                center: { lat: 39.8283, lng: -98.5795 },
                zoom: 4,
                styles: [
                    { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                    {
                        featureType: "administrative.locality",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#d59563" }],
                    },
                    {
                        featureType: "poi",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#d59563" }],
                    },
                    {
                        featureType: "poi.park",
                        elementType: "geometry",
                        stylers: [{ color: "#263c3f" }],
                    },
                    {
                        featureType: "poi.park",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#6b9a76" }],
                    },
                    {
                        featureType: "road",
                        elementType: "geometry",
                        stylers: [{ color: "#38414e" }],
                    },
                    {
                        featureType: "road",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#212a37" }],
                    },
                    {
                        featureType: "road",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#9ca5b3" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "geometry",
                        stylers: [{ color: "#746855" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#1f2835" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#f3d19c" }],
                    },
                    {
                        featureType: "transit",
                        elementType: "geometry",
                        stylers: [{ color: "#2f3948" }],
                    },
                    {
                        featureType: "transit.station",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#d59563" }],
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#17263c" }],
                    },
                    {
                        featureType: "water",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#515c6d" }],
                    },
                    {
                        featureType: "water",
                        elementType: "labels.text.stroke",
                        stylers: [{ color: "#17263c" }],
                    },
                ],
            });
            
            // Store map reference for tracking functionality
            trackingMap = map;
            
            // Load active loads for the map
            loadActiveLoads();
        }
    }
</script>
{% endblock %}
